#![no_std]
#![no_main]

use cortex_m_rt::entry;
use panic_halt as _;

use stm32f1xx_hal::{
    pac,
    prelude::*,
    i2c::{I2c, DutyCycle},
    gpio::GpioExt,
};

use ssd1306::{prelude::*, I2CDisplayInterface, Ssd1306};
use embedded_graphics::{
    prelude::*,
    pixelcolor::BinaryColor,
    image::{Image, ImageRawLE},
    primitives::{Line, PrimitiveStyle},
};
use micromath::F32Ext;
use core::f32::consts::PI;

/// داده‌ی تصویر Mado (128x64) از خروجی image2cpp
const MADO_BITS: &[u8] = &[
    0x80, 0x01, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0xc4, 0x00, 0x00, 
	0xc0, 0x0f, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x9f, 0x98, 0x00, 
	0xfe, 0x1f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xbf, 0xff, 0x00, 
	0xff, 0xff, 0xf3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xc0, 
	0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x79, 0xff, 0xc0, 
	0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xc0, 
	0xff, 0xfe, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3a, 0xff, 0xc0, 
	0x1f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x80, 
	0x03, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7b, 0xc0, 
	0x01, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x80, 
	0x03, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 
	0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xe0, 
	0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf8, 
	0x7f, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xf8, 
	0x3f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x03, 0xf8, 
	0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x39, 0xf0, 
	0x1e, 0x30, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xc7, 0x00, 0x00, 0x00, 0x3f, 0xf0, 
	0x7c, 0x40, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x1f, 0xf8, 
	0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xf2, 0x00, 0x00, 0x00, 0x07, 0xff, 
	0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0x00, 0x00, 0x3f, 0xf8, 0x00, 0x00, 0x1f, 0xff, 
	0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xfe, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x7f, 0xff, 
	0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0x80, 0x00, 0x3f, 0x00, 0x00, 0x03, 0xff, 0xff, 
	0xff, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xfc, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x07, 0xff, 0xfe, 
	0xff, 0x00, 0x00, 0x40, 0x00, 0x01, 0xff, 0xfe, 0x00, 0x01, 0xfe, 0x00, 0x00, 0x0f, 0xff, 0xfe, 
	0xff, 0x00, 0x00, 0x8e, 0x00, 0x03, 0xff, 0xff, 0xfc, 0x0f, 0xfe, 0x00, 0x00, 0x0f, 0xff, 0xfe, 
	0x7f, 0x00, 0x00, 0xde, 0x06, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x1f, 0xff, 0xff, 
	0x7f, 0x80, 0x00, 0xfc, 0x0f, 0x87, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x3f, 0xff, 0xff, 
	0x7f, 0xc0, 0x00, 0xfd, 0x8f, 0x83, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x3f, 0xff, 0xfe, 
	0x7f, 0xe0, 0x00, 0x7f, 0xe7, 0x83, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x9f, 0xff, 0xfc, 
	0x1f, 0xfc, 0x00, 0x3f, 0xf9, 0x41, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x1f, 0xff, 0xff, 
	0x0f, 0xff, 0x00, 0x0f, 0xff, 0xc3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x19, 0x7f, 0xff, 0xff, 
	0x0f, 0xff, 0x00, 0x01, 0xff, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xf1, 0xc0, 0x3f, 0xff, 0xff, 0xff, 
	0x07, 0xff, 0x00, 0x00, 0x0f, 0x79, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x19, 0xff, 0xff, 0xff, 0xff, 
	0x07, 0xff, 0x80, 0x00, 0x00, 0x33, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xff, 0xff, 
	0x03, 0xff, 0xc0, 0x00, 0x18, 0x33, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xff, 0xe1, 
	0x01, 0xff, 0xe0, 0x00, 0x3f, 0x89, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0xff, 0xe1, 
	0x00, 0x1f, 0xf0, 0x00, 0x3f, 0x80, 0x7f, 0xff, 0xff, 0xf0, 0x00, 0x7f, 0xff, 0xfe, 0x01, 0xff, 
	0x00, 0x03, 0xe0, 0x00, 0x3f, 0xc0, 0x3f, 0xff, 0xff, 0x00, 0x00, 0x7f, 0xff, 0xf0, 0x00, 0x7f, 
	0x00, 0x00, 0x00, 0x00, 0x7f, 0xe0, 0x0f, 0xff, 0xff, 0xff, 0xfc, 0x7f, 0xff, 0x80, 0x38, 0x1f, 
	0x00, 0x00, 0x00, 0x00, 0x7f, 0xe0, 0x03, 0xff, 0xff, 0xf8, 0x00, 0xff, 0xff, 0x80, 0x7e, 0x1f, 
	0x00, 0x00, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x7f, 0xff, 0xf0, 0x01, 0xff, 0xff, 0x80, 0xff, 0xff, 
	0x00, 0x00, 0x00, 0x01, 0xff, 0xf8, 0x00, 0x0f, 0xff, 0xff, 0xc3, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0x00, 0x00, 0x00, 0x03, 0xff, 0xfc, 0x00, 0x01, 0xff, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0x00, 0x00, 0x00, 0x17, 0xff, 0xfe, 0x00, 0x00, 0x0f, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0x80, 0x00, 0x00, 0x3c, 0x07, 0xff, 0xfe, 0x07, 0xf8, 0x0f, 
	0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x0f, 0xfe, 0x00, 0x00, 0xf8, 0x00, 
	0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x1f, 0xfc, 0x00, 0x00, 0x78, 0x00, 
	0x01, 0xf0, 0x3f, 0xff, 0xff, 0xff, 0xec, 0x00, 0x07, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x40, 0x0f, 0xff, 0xff, 0xfe, 0xfc, 0x00, 0x00, 0x00, 
	0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x17, 0xff, 0xff, 0xfe, 0x3f, 0x00, 0x00, 0x00, 
	0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x3f, 0xff, 0xff, 0xf0, 0xff, 0x00, 0x00, 0x00, 
	0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x7c, 0x00, 0x7e, 0x00, 0x1f, 0x80, 0xff, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xf0, 0x7f, 0xff, 0xfc, 0x3c, 0x01, 0xfd, 0x00, 0x00, 0x01, 0x7f, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xfc, 0x07, 0xff, 0xf0, 0x00, 0x00, 0x6c, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xfc, 0x00, 0x3f, 0xe0, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0x80, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
];

#[entry]
fn main() -> ! {
    let dp = pac::Peripherals::take().unwrap();
    let mut rcc = dp.RCC.constrain();
    let mut gpiob = dp.GPIOB.split(&mut rcc);

    // I2C pins
    let scl = gpiob.pb6.into_alternate_open_drain(&mut gpiob.crl);
    let sda = gpiob.pb7.into_alternate_open_drain(&mut gpiob.crl);

    // I2C init
    let i2c = I2c::new(
        dp.I2C1,
        (scl, sda),
        stm32f1xx_hal::i2c::Mode::fast(400.kHz(), DutyCycle::Ratio2to1),
        &mut rcc,
    );

    // SSD1306 init
    let interface = I2CDisplayInterface::new(i2c);
    let mut disp = Ssd1306::new(interface, DisplaySize128x64, DisplayRotation::Rotate0)
        .into_buffered_graphics_mode();
    disp.init().unwrap();

    // ----------- مرحله اول: نمایش تصویر Mado 128x64 -----------
    let raw: ImageRawLE<BinaryColor> = ImageRawLE::new(MADO_BITS, 128);
    let image = Image::new(&raw, Point::new(0, 0));
    image.draw(&mut disp).unwrap();
    disp.flush().unwrap();

    // کمی مکث برای دیدن تصویر
    cortex_m::asm::delay(72_000_00 * 2);

    // ----------- مرحله دوم: نمایش مکعب چرخان -----------
    let style = PrimitiveStyle::with_stroke(BinaryColor::On, 1);
    let mut angle: f32 = 0.0;

    loop {
        disp.clear();

        // نقاط مکعب
        let cube_points = [
            [-1.0, -1.0, -1.0],
            [ 1.0, -1.0, -1.0],
            [ 1.0,  1.0, -1.0],
            [-1.0,  1.0, -1.0],
            [-1.0, -1.0,  1.0],
            [ 1.0, -1.0,  1.0],
            [ 1.0,  1.0,  1.0],
            [-1.0,  1.0,  1.0],
        ];

        // چرخش حول محور Y
        let cos_a = angle.cos();
        let sin_a = angle.sin();

        let mut projected = [Point::new(0,0); 8];
        for (i, p) in cube_points.iter().enumerate() {
            let x = p[0]*cos_a + p[2]*sin_a;
            let y = p[1];
            let z = -p[0]*sin_a + p[2]*cos_a + 3.0;

            let px = (x/z * 40.0 + 64.0) as i32;
            let py = (y/z * 40.0 + 32.0) as i32;
            projected[i] = Point::new(px, py);
        }

        // یال‌های مکعب
        let edges = [
            (0,1),(1,2),(2,3),(3,0),
            (4,5),(5,6),(6,7),(7,4),
            (0,4),(1,5),(2,6),(3,7),
        ];

        for &(a,b) in &edges {
            Line::new(projected[a], projected[b])
                .into_styled(style)
                .draw(&mut disp).unwrap();
        }

        disp.flush().unwrap();

        angle += PI/15.0; // گام بزرگ‌تر برای سرعت بیشتر
        if angle > 2.0 * PI { angle -= 2.0 * PI; }

        cortex_m::asm::delay(200_000); // تاخیر کوچک برای دیدن انیمیشن
    }
}
//##################################################
1. تغییر تنظیمات در image2cpp
در سایت، تصویرت را بده و در بخش Output format گزینه‌ی XBM یا Arduino code را انتخاب کن.

در سایت image2cpp بخش Draw mode را روی Horizontal, 1 bit per pixel بگذار.

این حالت خروجی را به صورت row-major می‌دهد که با ImageRawLE سازگار است.

اگر روی Vertical, 1 bit per pixel باشد، تصویر به‌هم‌ریخته دیده می‌شود.
